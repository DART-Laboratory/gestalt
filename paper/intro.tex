\section{Introduction}
\label{s:intro}

Intrusion Detection Systems (IDSes) play an essential role in enterprise security strategies to counteract Advanced Persistent Threats (APTs). APTs are notably stealthy and persistent, exemplified by the significant system disruptions seen in attacks such as Solar Winds~\cite{solarwinds} and NotPetya~\cite{notpetya}. The effectiveness of IDSes hinges on their ability to accurately detect these threats, maintain low false positive rates, and operate with minimal resource consumption, ensuring system performance is not compromised.

%\wajih{Give the workflow of MSSP and cite that organizations outsource their security. If you find any numbers on how many comapnies use MSSP and outsource their security operations that would be great. If you find any realworld attack examples on MSSP where the data was leaked that would be great as well. }

Many organizations outsource their security operations to different MSSPs. A study~\cite{msspsurvey}  of more than 5,000 IT professionals found that nearly three in every four companies are turning to MSSPs The MSSP integrates their security tools with the client's systems to collect audit logs. This often involves configuring the clientâ€™s systems to send audit logs to the MSSP's security operations center (SOC) for analysis. 

The MSSP can use a range of techniques to analyze these audit logs for detecting theats. Data Provenance techniques have been increasingly used in IDSes to detect system intrusions. By analyzing system (audit) logs and converting them into provenance graphs, these systems offer a comprehensive view of system execution. Provenance-based IDSes~\cite{streamspot,provdetector2020,wang2022threatrace,shadewatcher,yangprographer,han2020unicorn} have emerged as a potent solution, utilizing the rich context within audit logs to improve detection capabilities.

Despite their promise, the current mode of operation of MSSP and the techniques employed for detecting intrusions face significant challenges in the complex landscape of enterprise security:

\begin{itemize} [leftmargin=*]
    \item[--] \textbf{Lack of Privacy Preservation:} Traditional provenance-based IDSes (PIDS)~\cite{flash2024,cheng2023kairos,wang2022threatrace} rely on a centralized infrastructure, necessitating client machines to transmit their log data to a central server. Flash~\cite{flash2024} and Kairos~\cite{cheng2023kairos} are some recent state-of-the-art PIDS that operate in a centralized manner, assuming the audit logs from different machines will be present in a centralized location where these systems are operational. This approach risks user privacy as audit logs encompass detailed records of system execution, including sensitive information and activity patterns.
    
    \item[--] \textbf{Excessive Network and Disk Overhead:} Audit logs from modern systems can accumulate to gigabytes per day, resulting in significant network costs for both users and organizations. Additionally, the need for extensive disk storage to house these logs adds complexity. Current PIDS models fail to address these challenges, undermining their practical applicability. Our analysis of Flash and Kairos, utilizing the \optc dataset as detailed in Section~\ref{sec:eval}, illustrates this point. For an organization similar to the one represented in the \optc dataset, with a comparable number of hosts, the total volume of logs transmitted daily would reach 1000 GB. This volume of data could lead to substantial network and storage expenses daily. Moreover, it poses a significant challenge for users with limited network bandwidth to upload this volume of data efficiently.
    %\wajih{Could you give specific numbers about network overhead and disk overhead that would be great.} \wajih{Again cite existing PIDS with names that would suffer from this issue.}
    
    \item[--] \textbf{Scalability Challenges:} The centralized approach used by current Provenance-based Intrusion Detection Systems (PIDS) leads to scalability challenges as the number of hosts in an organization increases. This centralization acts as a bottleneck, impeding efficient intrusion detection on a larger scale. Our evaluations of Flash and Kairos reveal that these systems would encounter log congestion in organizations comparable to the size represented by the \optc dataset. As detailed in Section~\ref{sec:eval}, Flash would require 27.7 hours, and Kairos 56.6 hours, to process a single day's worth of logs from the \optc dataset. %\wajih{Again you need to add more details here about scalability issues. Having specific numbers for existing PIDS is important. Also cite those existing PIDS }
\end{itemize}

Federated learning~\cite{mcmahan2017communication} is a promising solution to deal with the challenges outlined earlier. This is a machine learning approach that enables a model to be trained across multiple decentralized devices holding local data samples, without exchanging them. This method addresses privacy concerns, bandwidth limitations, and data security issues inherent in centralized machine learning approaches

%\wajih{Add one paragraph here explaining that why is it challenging to directly apply FL to PIDS.}

However, integrating Federated Learning (FL) into existing Provenance-based Intrusion Detection Systems (PIDS) presents significant challenges. FL requires addressing key issues, such as managing data imbalance among clients and coping with heterogeneous and non-Independent and Identically Distributed (Non-IID) data~\cite{zhao2018federated}. The current designs of these systems lack built-in mechanisms to tackle these problems. Furthermore, as detailed in Section~\ref{sec:motivation}, the architectural foundations of these systems do not naturally accommodate the application of FL.

%\wajih{Add one paragraph how you solve that above mentioned challenge. This will highlight the novelty of your system.}

To tackle these challenges, we introduce \Sys, a novel Provenance-based Intrusion Detection System (PIDS) that merges provenance graph representation learning with Federated Learning (FL). This hybrid approach facilitates efficient and precise detection of Advanced Persistent Threat (APT) attacks in a decentralized fashion, ensuring the preservation of user privacy. We have devised several innovative techniques to navigate the challenges inherent in applying FL to PIDS. In particular, we present a personalized \gnnshort Learning framework that is customized at the system entity level to deal with heterogeneous and imbalanced clients, alongside a multi-server architecture designed explicitly to protect user log privacy.

%\wajih{make sure to say two or three lines about adversarial attacks and say that more details are present in the discussion section.}

%\wajih{Add one paragraph related to evaluation results.}

We have conducted thorough evaluations of our system's effectiveness using open-source datasets from DARPA, specifically E3, E5, and \optc. These datasets cover a wide range of attack scenarios and system behaviors. Our findings demonstrate that \Sys achieves detection performance comparable to state-of-the-art centralized systems like FLASH and KAIROS, while also offering significant advantages in terms of scalability, efficiency, and privacy preservation. However, employing Federated Learning (FL) exposes our system to certain types of adversarial attacks, such as model poisoning, inference, and gradient attacks. We provide a comprehensive analysis of our system's resilience against these attacks in the discussion section~\ref{sec:discussion}.

\wajih{Add list of main contributions}


\PP{Open Source Commitment} To advance threat detection research and ensure reproducibility, we plan to release the source code of \Sys publicly upon the publication of this paper.